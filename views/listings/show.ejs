<% layout("/layouts/boilerplate") %>

<div class="row mt-3">
  <div class="col-12 col-lg-10 offset-lg-1">
    <!-- Listing Header -->
    <div class="mb-4">
      <h1 style="font-size: 2.5rem; font-weight: 700; margin-bottom: 0.5rem;">
        <%= listing.title %>
      </h1>
      <div style="display: flex; align-items: center; gap: 1rem; color: var(--text-light);">
        <span><i class="fa-solid fa-location-dot"></i> <%= listing.location %>, <%= listing.country %></span>
        <span>â€¢</span>
        <span>Hosted by <strong style="color: var(--text-dark);"><%= listing.owner ? listing.owner.username : "Unknown" %></strong></span>
      </div>
    </div>

    <!-- Main Image -->
    <div class="mb-4">
      <img src="<%= listing.image?.url || '' %>" class="show-img" alt="<%= listing.title %>">
    </div>

    <!-- Listing Details Card -->
    <div class="card" style="border: none; box-shadow: var(--shadow-md); border-radius: 20px; padding: 2rem; margin-bottom: 2rem;">
      <div class="row">
        <div class="col-12 col-md-8">
          <h3 style="font-weight: 700; margin-bottom: 1rem; color: var(--text-dark);">About this listing</h3>
          <p style="color: var(--text-dark); line-height: 1.8; font-size: 1.1rem;">
            <%= listing.description %>
          </p>
        </div>
        <div class="col-12 col-md-4">
          <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 2rem; border-radius: 20px; color: white; text-align: center;">
            <p style="font-size: 0.9rem; opacity: 0.9; margin-bottom: 0.5rem;">Price per day</p>
            <h2 style="font-size: 2.5rem; font-weight: 700; margin: 0;">
              <%= (listing.price || 0).toLocaleString("en-IN", { style: "currency", currency: "INR" }) %>
            </h2>
          </div>
        </div>
      </div>
    </div>

    <!-- Action Buttons -->
    <% if (currUser && listing.owner && listing.owner.equals(currUser._id)) { %>
      <div class="buttons mb-4">
        <a href="/listings/<%= listing._id %>/edit" class="show-btns">
          <i class="fa-solid fa-edit me-2"></i> Edit Listing
        </a>
        <form action="/listings/<%=listing._id%>?_method=DELETE" method="post" style="display: inline;">
          <button type="submit" class="show-btns" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">
            <i class="fa-solid fa-trash me-2"></i> Delete
          </button>
        </form>
      </div>
    <% } %>

    <hr style="margin: 3rem 0; border: none; border-top: 2px solid var(--border-color);">

    <!-- Review Form -->
    <div class="card" style="border: none; box-shadow: var(--shadow-md); border-radius: 20px; padding: 2rem; margin-bottom: 2rem;">
      <h3 style="font-weight: 700; margin-bottom: 1.5rem;">Leave a Review</h3>
      <form action="/listings/<%= listing.id %>/reviews" method="post" novalidate class="needs-validation">
        <div class="mb-3">
          <label for="review[rating]" class="form-label">Rating</label>
          <fieldset class="starability-slot">
            <legend style="display: none;">Rating:</legend>
            <input type="radio" id="no-rate" class="input-no-rate" name="review[rating]" value="0" checked aria-label="No rating." />
            <input type="radio" id="first-rate1" name="review[rating]" value="1" />
            <label for="first-rate1" title="Terrible">1 star</label>
            <input type="radio" id="first-rate2" name="review[rating]" value="2" />
            <label for="first-rate2" title="Not good">2 stars</label>
            <input type="radio" id="first-rate3" name="review[rating]" value="3" />
            <label for="first-rate3" title="Average">3 stars</label>
            <input type="radio" id="first-rate4" name="review[rating]" value="4" />
            <label for="first-rate4" title="Very good">4 stars</label>
            <input type="radio" id="first-rate5" name="review[rating]" value="5" />
            <label for="first-rate5" title="Amazing">5 stars</label>
          </fieldset>
        </div>

        <div class="mb-3">
          <label for="comment" class="form-label">Comment</label>
          <textarea name="review[comment]" id="comment" cols="30" rows="5" 
                    class="form-control" placeholder="Share your experience..." required></textarea>
          <div class="invalid-feedback">Please write a comment to review</div>
        </div>
        
        <button type="submit" class="btn btn-success">
          <i class="fa-solid fa-paper-plane me-2"></i> Submit Review
        </button>
      </form>
    </div>

    <!-- Reviews Section -->
    <% if (listing.reviews && listing.reviews.length > 0) { %>
      <div class="mb-4">
        <h3 style="font-weight: 700; margin-bottom: 1.5rem;">
          Reviews (<%= listing.reviews.length %>)
        </h3>
        
        <div class="row">
          <% for(review of listing.reviews) { %>
            <div class="col-12 col-md-6 mb-3">
              <div class="review-card">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                  <h5 style="font-weight: 700; margin: 0; color: var(--text-dark);">
                    <%= review.author.username %>
                  </h5>
                  <p class="starability-result" data-rating="<%= review.rating %>"></p>
                </div>
                <p style="color: var(--text-dark); line-height: 1.6; margin-bottom: 1rem;">
                  <%= review.comment %>
                </p>
                <% if (currUser && review.author && review.author.equals(currUser._id)) { %>
                  <form action="/listings/<%= listing._id %>/reviews/<%= review._id%>?_method=DELETE" 
                        method="POST" style="margin: 0;">
                    <button type="submit" class="btn btn-sm btn-dark">
                      <i class="fa-solid fa-trash me-1"></i> Delete
                    </button>
                  </form>
                <% } %>
              </div>
            </div>
          <% } %>
        </div>
      </div>
    <% } else { %>
      <div class="card" style="border: none; box-shadow: var(--shadow-md); border-radius: 20px; padding: 3rem; text-align: center; margin-bottom: 2rem;">
        <p style="color: var(--text-light); font-size: 1.1rem;">No reviews yet. Be the first to review!</p>
      </div>
    <% } %>

    <!-- Map Section -->
    <div class="mt-4">
      <h3 style="font-weight: 700; margin-bottom: 1rem;">Location</h3>
      <div id="map"></div>
    </div>
  </div>
</div>

<!-- <script src="/js/map.js"></script> -->
